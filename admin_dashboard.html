<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Geega Games</title>
  <style>
    * {
      box-sizing: border-box;
    }
  
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      margin: 0;
      background-color: #f4f6f8;
      color: #333;
    }
  
    .sidebar {
      background-color: rebeccapurple;
      color: white;
      padding: 20px;
      width: 220px;
      height: 100vh;
      transition: width 0.3s ease;
      overflow-x: hidden;
    }
  
    .sidebar.collapsed {
      width: 60px;
    }
  
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }
  
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      margin: 12px 0;
      font-size: 1rem;
      transition: padding 0.2s;
    }
  
    .sidebar a:hover {
      text-decoration: underline;
      padding-left: 5px;
    }
  
    .sidebar-toggle {
      background: white;
      color: rebeccapurple;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 16px;
      margin-bottom: 15px;
      cursor: pointer;
    }
  
    .main {
      flex-grow: 1;
      padding: 30px;
      background-color: #ecf0f1;
    }
  
    .section {
      background-color: white;
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
  
    .collapsible {
      display: none;
    }
  
    .collapsible.active {
      display: block;
    }
  
    .right-menu {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 60px;
      background-color: rebeccapurple;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      z-index: 1100;
      transition: width 0.3s ease;
    }
  
    .right-menu.expanded {
      width: 400px;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }
  
    .right-menu button.toggle-panel {
      background: white;
      color: rebeccapurple;
      border: none;
      padding: 8px 12px;
      margin: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
  
    .right-panel-content {
      display: none;
      width: 100%;
    }
  
    .right-menu.expanded .right-panel-content {
      display: block;
      color: #333;
    }
  
    #search-results,
    #delete-search-results {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 10px;
      justify-content: center;
    }
  
    .card-item,
    .delete-card-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 170px;
      background: #ffffff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
  
    .card-item:hover {
      transform: scale(1.04);
      background-color: #f2e7ff;
    }
  
    .delete-card-item:hover {
      transform: scale(1.04);
      background-color: #ffe7e7;
    }
  
    .card-item img,
    .delete-card-item img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
  
    .card-details,
    .delete-card-details {
      margin-top: 10px;
      text-align: center;
    }
  
    .card-details strong,
    .delete-card-details strong {
      font-size: 1.05em;
      display: block;
    }
  
    .card-details span,
    .delete-card-details span {
      display: block;
      font-size: 0.9em;
      margin: 4px 0;
    }
  
    .card-details label {
      font-size: 0.9em;
      color: #444;
      display: block;
      margin-top: 4px;
    }
  
    .card-details select {
      margin-top: 4px;
      padding: 4px;
      font-size: 0.9em;
      width: 100%;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  
    .card-details .add-button {
      margin-top: 8px;
      background-color: rebeccapurple;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
  
    .card-details .add-button:hover {
      background-color: #6a2f9c;
    }
  
    .delete-card-details button {
      margin-top: 8px;
      background-color: crimson;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
  
    .delete-card-details button:hover {
      background-color: #a30000;
    }
  
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
  
    input, textarea, button, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 14px;
      font-size: 14px;
    }
  
    button {
      background-color: rebeccapurple;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
  
    button:hover {
      background-color: #5a2d85;
    }
  
    input::-webkit-autofill,
    input:-webkit-autofill {
      box-shadow: 0 0 0px 1000px white inset !important;
      -webkit-box-shadow: 0 0 0px 1000px white inset !important;
    }
  
    .shimmer {
      background: linear-gradient(to right, rebeccapurple 4%, #ffffff 25%, rebeccapurple 36%);
      background-size: 200% auto;
      color: white;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s linear infinite;
      font-weight: bold;
    }
  
    @keyframes shimmer {
      to {
        background-position: 200% center;
      }
    }

    #price-search-results {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 16px;
      padding: 10px 0;
      scroll-behavior: smooth;
    }

    .price-card {
      min-width: 160px;
      max-width: 160px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 10px;
      text-align: center;
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }

    .price-card:hover {
      transform: scale(1.04);
      background-color: #f2f2ff;
    }

    .price-card img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .price-card strong {
      display: block;
      font-size: 1.05em;
      margin-top: 6px;
    }

    .price-card span {
      display: block;
      font-size: 0.9em;
      margin: 4px 0;
    }

    .price-card button {
      margin-top: 8px;
      background-color: seagreen;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .price-card button:hover {
      background-color: #146c43;
    }

    .order-card {
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 24px;
      padding: 20px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .order-header h3 {
      margin: 0;
      color: #4b0082;
    }

    .order-details p {
      margin: 6px 0;
      font-size: 0.95rem;
    }

    .order-status {
      margin-top: 10px;
    }

    .order-status select {
      padding: 6px;
      border-radius: 6px;
      font-size: 0.95rem;
      border: 1px solid #ccc;
    }

    .order-tracking {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-tracking input {
      width: 200px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .card-list {
      list-style: none;
      padding-left: 0;
      margin-top: 15px;
    }

    .card-item-summary {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .card-item-summary img {
      width: 75px;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .card-info {
      flex-grow: 1;
    }

    .card-info div {
      font-size: 14px;
      margin: 2px 0;
    }

    input.highlighted {
      box-shadow: 0 0 6px 2px gold;
      transition: box-shadow 0.3s ease;
    }

    /* ‚≠ê MTG Trends styles */
    .mtg-trends-card {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      background: #ffffff;
    }

    .mtg-trends-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 1rem;
    }

    .mtg-trends-inputs label,
    .mtg-trends-form-grid label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .mtg-trends-inputs input,
    .mtg-trends-form-grid input,
    #mtgTrendsNotes,
    #mtgTrendsHeat {
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    .mtg-trends-inputs button {
      margin-top: 0.4rem;
    }

    .mtg-trends-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    #mtgTrendsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    #mtgTrendsTable th,
    #mtgTrendsTable td {
      border: 1px solid #eee;
      padding: 0.4rem 0.5rem;
      vertical-align: top;
    }

    #mtgTrendsTable th {
      background: #f5f5f5;
    }

    .mtg-trends-delete {
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
    }
  </style>
  
<!-- üîê Login Logic (commented out)
<script>
  //document.getElementById("admin-login-form").addEventListener("submit", function (e) {
  //  e.preventDefault();
  //
  //  const passwordInput = document.getElementById("admin-password-input");
  //  const errorMessage = document.getElementById("login-error");
  //  const loginOverlay = document.getElementById("admin-login");
  //
  //  const password = passwordInput.value.trim();
  //
  //  if (password === "yourSecretPassword") {
  //    loginOverlay.style.display = "none";
  //    errorMessage.textContent = "";
  //    console.log("‚úÖ Admin logged in.");
  //  } else {
  //    errorMessage.textContent = "‚ùå Incorrect password";
  //    passwordInput.value = "";
  //    passwordInput.focus();
  //  }
  //});
</script>-->
</head>
<body>
  <!-- üîê Login Overlay (commented out)
  <div id="admin-login" ...>...</div>
  -->

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <h2>Geega Admin</h2>
    <a href="#" onclick="showSection('inventory-section')">Inventory</a>
    <a href="#" onclick="showSection('orders-section'); loadOrders();">
      Orders <span id="order-count" style="background: white; color: rebeccapurple; font-weight: bold; padding: 2px 6px; border-radius: 8px; font-size: 0.85em;">0</span>
    </a>
    <a href="#" onclick="showSection('collections-section'); loadCollections();">
      Incoming Collections
    </a>
    <a href="#" onclick="showSection('user-management-section')">User Management</a>
    <a href="#" onclick="showSection('announcement-section')">Post Announcement</a>
    <a href="#" onclick="showSection('employee-section')">Add Employee</a>
    <!-- ‚≠ê New MTG Trends tab -->
    <a href="#" onclick="showSection('mtg-trends-section')">MTG Trends</a>
    <a href="#">Logout</a>
  </div>
  
  <!-- Main Content -->
  <div class="main">

    <!-- ‚≠ê MTG Trends Section -->
    <div class="section" id="mtg-trends-section" style="display:none;">
      <h2>MTG Trends (Local Google Radar)</h2>

      <!-- QUICK GOOGLE TOOLS -->
      <div class="card mtg-trends-card">
        <h3>Quick Google Tools</h3>
        <p>Use these shortcuts to quickly check how hot MTG is in different areas.</p>

        <div class="mtg-trends-grid">
          <div class="mtg-trends-inputs">
            <label>
              City / Area
              <input type="text" id="mtgTrendsCity" placeholder="e.g. Belleville">
            </label>

            <label>
              State (2-letter code)
              <input type="text" id="mtgTrendsState" maxlength="2" placeholder="e.g. IL">
            </label>

            <button type="button" onclick="openGoogleTrends()">Open Google Trends</button>
            <button type="button" onclick="openGoogleMapsShops()">Find Card Shops (Maps)</button>
            <button type="button" onclick="openGoogleSellSearch()">Search 'Sell Magic Cards'</button>
            <button type="button" onclick="openGoogleBuySearch()">Search 'Buy Magic Cards'</button>
          </div>

          <div class="mtg-trends-help">
            <h4>How to use this</h4>
            <ul>
              <li><strong>Google Trends</strong>: See which cities in your state search MTG the most.</li>
              <li><strong>Card shops on Maps</strong>: Check review counts & recent activity.</li>
              <li><strong>Sell / Buy searches</strong>: See which nearby cities have the most posts.</li>
            </ul>
            <p>Then log what you find below so you can spot patterns over time.</p>
          </div>
        </div>
      </div>

      <!-- MANUAL LOG / TREND TRACKER -->
      <div class="card mtg-trends-card">
        <h3>Trend Log</h3>
        <form id="mtgTrendsForm">
          <div class="mtg-trends-form-grid">
            <label>
              Date
              <input type="date" id="mtgTrendsDate">
            </label>

            <label>
              Area (City / Metro)
              <input type="text" id="mtgTrendsArea" placeholder="e.g. St. Louis Metro">
            </label>

            <label>
              Heat Level
              <select id="mtgTrendsHeat">
                <option value="Warm">Warm</option>
                <option value="Hot">Hot</option>
                <option value="On Fire">On Fire üî•</option>
                <option value="Cold">Cold</option>
              </select>
            </label>

            <label>
              Google Trends Score (0‚Äì100)
              <input type="number" id="mtgTrendsScore" min="0" max="100" placeholder="e.g. 78">
            </label>

            <label>
              Active Shops Count
              <input type="number" id="mtgTrendsShops" min="0" placeholder="e.g. 4">
            </label>
          </div>

          <label>
            Notes (formats, demand, what you noticed)
            <textarea id="mtgTrendsNotes" rows="3"
              placeholder="Commander nights packed, lots of FB listings, shop offers weak cash but strong store credit, etc."></textarea>
          </label>

          <button type="submit">Add Trend Entry</button>
        </form>

        <hr>

        <h4>Saved Trend Entries</h4>
        <table id="mtgTrendsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Area</th>
              <th>Heat</th>
              <th>Trend Score</th>
              <th>Shops</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Inventory Section -->
  <div class="section" id="inventory-section">
  <div id="inventory-summary" style="padding: 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center;">
    <h3 style="color: rebeccapurple;">Inventory Summary</h3>
    <p><strong>Total Cards:</strong> <span id="total-card-count">Loading...</span></p>
    <p><strong>Total Inventory Value:</strong> $<span id="total-inventory-value">Loading...</span></p>
  </div>

  <h2>Add Inventory</h2>
  <h3>Search Magic Card</h3>
  <input type="text" id="search-input" placeholder="Type card name..." autocomplete="off" />
  <div id="search-results" style="margin-top: 10px;"></div>
  <hr style="margin: 20px 0;">

  <form id="update-card-form">
    <label for="cardName">Card Name</label>
    <input type="text" id="cardName" name="cardName" required>

    <label for="quantity">Quantity</label>
    <input type="number" id="quantity" name="quantity" min="0" required>

    <label for="set">Set</label>
    <input type="text" id="set" name="set" required>

    <label for="condition">Condition</label>
    <select id="condition" name="condition" required>
      <option value="">Select Condition</option>
      <option value="NM">Near Mint</option>
      <option value="LP">Lightly Played</option>
      <option value="MP">Moderately Played</option>
      <option value="HP">Heavily Played</option>
      <option value="DMG">Damaged</option>
    </select>

    <label for="price">Price (USD)</label>
    <input type="number" id="price" name="price" min="0" step="0.01" required>

    <label for="variantType">Variant Type</label>
    <input type="text" id="variantType" name="variantType" placeholder="e.g. Borderless, Extended Art" />

    <input type="hidden" id="imageUrl" name="imageUrl">
    <input type="hidden" id="rarity" name="rarity">

    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
      <input type="checkbox" id="foil" name="foil" style="width: 20px; height: 20px;">
      <label for="foil" class="shimmer" style="margin: 0; font-size: 1.1rem;">Foil</label>
    </div>

    <button type="submit">Add / Update Card</button>
  </form>

  <h3>Update Card Price</h3>
  <h3>Search Inventory to Update Price</h3>
  <input type="text" id="price-search-input" placeholder="Search inventory by name or set..." autocomplete="off" />
  <div id="price-search-results" style="margin-top: 10px;"></div>

  <form id="price-update-form">
    <label for="priceCardName">Card Name</label>
    <input type="hidden" id="priceCardName" required>


    <label for="priceSet">Set</label>
    <input type="hidden" id="priceSet" required>

    <label for="priceFoil">Foil?</label>
    <input type="hidden" id="priceFoil" required>

    <input type="hidden" id="priceVariantType" required>

    <label for="newPrice">New Price (USD)</label>
    <input type="number" id="newPrice" min="0" step="0.01" required>

    <button type="submit">Update Price</button>
  </form>

  <hr style="margin: 30px 0;">

  <h3>Delete Card from Inventory</h3>
  <form id="delete-card-form">
    <label for="delete-search-input">Card Name</label>
    <input type="text" id="delete-search-input" placeholder="Search inventory..." autocomplete="off" />
    <div id="delete-search-results" style="margin-top: 10px;"></div>
    <input type="hidden" id="deleteCardName" name="deleteCardName" required>
    <input type="hidden" id="deleteSet" name="deleteSet" required>
    <input type="hidden" id="deleteFoil" name="deleteFoil" required>
    <input type="hidden" id="deleteVariantType" name="deleteVariantType">
    <input type="hidden" id="deleteColors" name="deleteColors">
    <input type="hidden" id="deleteCardType" name="deleteCardType">
    <input type="hidden" id="deleteCreatureTypes" name="deleteCreatureTypes">
    <button type="submit" style="background-color: crimson;">Delete Card</button>
  </form>

   <!-- üö® DANGER ZONE: CLEAR ENTIRE INVENTORY -->
  <div style="margin-top: 16px; padding: 14px; border: 2px dashed crimson; border-radius: 12px; background: #fff5f5;">
    <h3 style="margin: 0 0 10px; color: crimson;">Danger Zone</h3>
    <button id="clearInventoryBtn" type="button" style="background: crimson;">
      Clear ENTIRE Inventory
    </button>
    <p style="margin: 10px 0 0; font-size: 0.9rem; color: #555;">
      This permanently deletes all inventory items in the database.
    </p>
  </div>
</div>

    <!-- Orders Section -->
    <div class="section" id="orders-section" style="display: none;">
      <h2>Order Management</h2>
      <div id="orders-list">
        <p>Loading orders...</p>
      </div>
    </div>

    <!-- Incoming Collections Section -->
    <div class="section" id="collections-section" style="display:none;">
      <h2>Incoming Collections</h2>

      <div id="collections-filters" style="margin-bottom: 16px; display:flex; gap:10px; flex-wrap:wrap;">
        <select id="collections-status-filter" style="max-width:200px;">
          <option value="">All Statuses</option>
          <option value="New">New</option>
          <option value="Reviewing">Reviewing</option>
          <option value="Offer Sent">Offer Sent</option>
          <option value="Accepted">Accepted</option>
          <option value="Declined">Declined</option>
          <option value="Completed">Completed</option>
        </select>
        <input
          type="text"
          id="collections-search"
          placeholder="Search by name, email, or notes..."
          style="max-width:260px;"
        />
      </div>

      <div id="collections-list">
        <p>Loading incoming collections...</p>
      </div>
    </div>
  
    <!-- User Management Section -->
    <div class="section" id="user-management-section" style="display:none;">
      <h2>User Management</h2>
      <div id="user-list">
        <p>Loading users...</p>
      </div>

      <button id="send-optin-button" style="margin-top: 12px;">Send Opt-In Email to All Users</button>
    </div>
    
    <!-- Post Announcement Section -->
    <div class="section" id="announcement-section" style="display:none;">
      <h2>Post Announcement</h2>
      <form id="announcement-form">
        <label for="announcement">Message</label>
        <textarea id="announcement" rows="4" required></textarea>
        <label for="announcement-type">Send via:</label>
        <select id="announcement-type" required>
          <option value="email">Email Only</option>
          <option value="sms">SMS Only</option>
          <option value="both">Both Email & SMS</option>
        </select>
        <button type="submit">Post Announcement</button>
      </form>
    </div>
  
    <!-- Add Employee Section -->
    <div class="section" id="employee-section" style="display:none;">
      <h2>Add Employee</h2>
      <form id="add-employee-form">
        <label for="employeeRole">Role</label>
        <select id="employeeRole" name="employeeRole" required>
          <option value="">Select Role</option>
          <option value="Admin">Admin</option>
          <option value="Buyback Buddy">Buyback Buddy</option>
          <option value="Card Slinger">Card Slinger</option>
          <option value="Event Coordinator">Event Coordinator</option>
          <option value="Inventory Management">Inventory Management</option>
          <option value="Manager">Manager</option>
        </select>
        <label for="employeeFirstName">First Name</label>
        <input type="text" id="employeeFirstName" name="employeeFirstName" required>
        <label for="employeeLastName">Last Name</label>
        <input type="text" id="employeeLastName" name="employeeLastName" required>
        <label for="employeePhone">Phone</label>
        <input type="tel" id="employeePhone" name="employeePhone" required>
        <label for="employeeEmail">Email</label>
        <input type="email" id="employeeEmail" name="employeeEmail" required>
        <label for="emergencyContact">Emergency Contact</label>
        <input type="text" id="emergencyContact" name="emergencyContact" required>
        <button type="submit">Add Employee</button>
      </form>
    </div>
  </div>
  
  <!-- JS for Sidebar, Section Switching, and MTG Trends -->
<script>
  // ===== SIDEBAR / SECTION SWITCHING =====
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
  }

  function showSection(sectionId) {
    document.querySelectorAll('.main .section').forEach(section => {
      section.style.display = 'none';
    });
    const target = document.getElementById(sectionId);
    if (target) target.style.display = 'block';
  }

  async function loadInventorySummary() {
  const countEl = document.getElementById('total-card-count');
  const valueEl = document.getElementById('total-inventory-value');
  if (!countEl || !valueEl) return;

  countEl.textContent = 'Loading...';
  valueEl.textContent = 'Loading...';

  try {
    const res = await fetch("https://geega-games-website-production.up.railway.app/api/inventory");
    if (!res.ok) throw new Error(`Inventory fetch failed: ${res.status}`);

    const items = await res.json();
    if (!Array.isArray(items)) throw new Error("Inventory response was not an array");

    let totalCards = 0;
    let totalValue = 0;

    for (const item of items) {
      const qty = parseInt(item.quantity, 10) || 0;
      totalCards += qty;

      const price =
        (item.foil ? (parseFloat(item.priceUsdFoil) || 0) : (parseFloat(item.priceUsd) || 0));

      totalValue += qty * price;
    }

    countEl.textContent = totalCards.toLocaleString();
    valueEl.textContent = totalValue.toFixed(2);
  } catch (err) {
    console.error("‚ùå loadInventorySummary error:", err);
    countEl.textContent = '‚Äî';
    valueEl.textContent = '‚Äî';
  }
}


  // ===== MTG TRENDS LOGIC =====
  const MTG_TRENDS_STORAGE_KEY = 'mtgTrendsEntries';

  function getInputValue(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
  }

  // --- GOOGLE SHORTCUTS ---
  function openGoogleTrends() {
    const state = getInputValue('mtgTrendsState').toUpperCase();
    const geo = state ? `US-${state}` : 'US';
    const url = `https://trends.google.com/trends/explore?geo=${encodeURIComponent(geo)}&q=${encodeURIComponent('Magic the Gathering')}`;
    window.open(url, '_blank');
  }

  function openGoogleMapsShops() {
    const city = getInputValue('mtgTrendsCity');
    const state = getInputValue('mtgTrendsState').toUpperCase();
    let query = 'Magic the Gathering card shop';
    if (city && state) query += ` ${city}, ${state}`;
    else if (state) query += ` ${state}`;
    const url = `https://www.google.com/maps/search/${encodeURIComponent(query)}`;
    window.open(url, '_blank');
  }

  function openGoogleSellSearch() {
    const city = getInputValue('mtgTrendsCity');
    const state = getInputValue('mtgTrendsState').toUpperCase();
    let query = 'sell Magic the Gathering cards';
    if (city && state) query += ` ${city} ${state}`;
    else if (state) query += ` ${state}`;
    const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    window.open(url, '_blank');
  }

  function openGoogleBuySearch() {
    const city = getInputValue('mtgTrendsCity');
    const state = getInputValue('mtgTrendsState').toUpperCase();
    let query = 'buy Magic the Gathering cards';
    if (city && state) query += ` ${city} ${state}`;
    else if (state) query += ` ${state}`;
    const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    window.open(url, '_blank');
  }

  // --- TREND LOG STORAGE ---
  function loadMtgTrendsEntries() {
    try {
      const raw = localStorage.getItem(MTG_TRENDS_STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('Failed to parse MTG trends entries:', e);
      return [];
    }
  }

  async function loadCollections() {
  const list = document.getElementById('collections-list');
  if (!list) return;

  list.innerHTML = '<p>Loading incoming collections...</p>';

  try {
    const res = await fetch('https://geega-games-website-production.up.railway.app/api/collections');
    if (!res.ok) throw new Error(`Server responded with ${res.status}`);
    const collections = await res.json();

    if (!Array.isArray(collections) || collections.length === 0) {
      list.innerHTML = '<p>No incoming collections yet.</p>';
      return;
    }

    list.innerHTML = collections.map(c => `
      <div class="section" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <strong>${(c.firstName || '‚Äî')} ${(c.lastName || '')}</strong><br/>
            <span>${c.email || '‚Äî'}</span><br/>
            <span>${c.phone || '‚Äî'}</span>
          </div>
          <div style="text-align:right;">
            <div><strong>Status:</strong> ${c.status || 'New'}</div>
            <div><strong>Total Cards:</strong> ${c.totalCards ?? (c.cards?.length || 0)}</div>
            <div><strong>Est. Value:</strong> $${(c.estimatedValue || 0).toFixed(2)}</div>
            <div style="font-size:0.85rem; color:#666;">
              ${c.submittedAt ? new Date(c.submittedAt).toLocaleString() : ''}
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <strong>Notes:</strong>
          <div style="white-space:pre-wrap;">${(c.notes || '')}</div>
        </div>

        <details style="margin-top:10px;">
          <summary style="cursor:pointer; font-weight:bold;">Cards (${c.cards?.length || 0})</summary>
          <ul style="padding-left:18px;">
            ${(c.cards || []).slice(0, 200).map(card => `
              <li>
                ${card.quantity ? `${card.quantity}x ` : ''}${card.cardName || '‚Äî'}
                ‚Äî ${card.set || '‚Äî'} ${card.foil ? '(Foil)' : ''} ${card.condition ? `‚Ä¢ ${card.condition}` : ''}
              </li>
            `).join('')}
          </ul>
        </details>
      </div>
    `).join('');
  } catch (err) {
    console.error('‚ùå loadCollections error:', err);
    list.innerHTML = '<p>‚ùå Failed to load incoming collections.</p>';
  }
}

  function saveMtgTrendsEntries(entries) {
    localStorage.setItem(MTG_TRENDS_STORAGE_KEY, JSON.stringify(entries));
  }

  function renderMtgTrendsTable() {
    const tbody = document.querySelector('#mtgTrendsTable tbody');
    if (!tbody) return;
    const entries = loadMtgTrendsEntries();
    tbody.innerHTML = '';

    entries.forEach((entry, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.date || ''}</td>
        <td>${entry.area || ''}</td>
        <td>${entry.heat || ''}</td>
        <td>${entry.trendScore || ''}</td>
        <td>${entry.shops || ''}</td>
        <td>${entry.notes || ''}</td>
        <td><button type="button" data-index="${index}" class="mtg-trends-delete">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.mtg-trends-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = parseInt(e.target.getAttribute('data-index'), 10);
        deleteMtgTrendsEntry(idx);
      });
    });
  }

  function deleteMtgTrendsEntry(index) {
    const entries = loadMtgTrendsEntries();
    if (index < 0 || index >= entries.length) return;
    entries.splice(index, 1);
    saveMtgTrendsEntries(entries);
    renderMtgTrendsTable();
  }

  function initMtgTrends() {
    const form = document.getElementById('mtgTrendsForm');
    const dateInput = document.getElementById('mtgTrendsDate');

    if (dateInput && !dateInput.value) {
      const today = new Date();
      dateInput.value = today.toISOString().slice(0, 10);
    }

    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const date = getInputValue('mtgTrendsDate');
        const area = getInputValue('mtgTrendsArea');
        const heatEl = document.getElementById('mtgTrendsHeat');
        const heat = heatEl ? heatEl.value : '';
        const trendScore = getInputValue('mtgTrendsScore');
        const shops = getInputValue('mtgTrendsShops');
        const notes = getInputValue('mtgTrendsNotes');

        if (!date || !area) {
          alert('Please enter at least a date and area.');
          return;
        }

        const entries = loadMtgTrendsEntries();
        entries.unshift({ date, area, heat, trendScore, shops, notes });
        saveMtgTrendsEntries(entries);

        form.reset();
        if (dateInput) {
          const today = new Date();
          dateInput.value = today.toISOString().slice(0, 10);
        }

        renderMtgTrendsTable();
      });
    }

    renderMtgTrendsTable();
  }

  // ===== DELETE SEARCH =====
  let deleteDebounceTimeout;

  document.getElementById('delete-search-input').addEventListener('input', function () {
    clearTimeout(deleteDebounceTimeout);
    const query = this.value.trim().toLowerCase();
    const resultsDiv = document.getElementById('delete-search-results');
    if (!query) {
      resultsDiv.innerHTML = '';
      return;
    }
    deleteDebounceTimeout = setTimeout(() => searchInventoryCards(query), 300);
  });

  async function searchInventoryCards(query) {
    const resultsDiv = document.getElementById('delete-search-results');
    resultsDiv.innerHTML = `<p>Searching inventory for "<strong>${query}</strong>"...</p>`;

    try {
      const res = await fetch("https://geega-games-website-production.up.railway.app/api/inventory");
      if (!res.ok) throw new Error("Error fetching inventory");

      const cards = await res.json();
      const filtered = cards.filter(card =>
        (card.cardName || '').toLowerCase().includes(query) ||
        (card.set || '').toLowerCase().includes(query)
      );

      if (filtered.length === 0) {
        resultsDiv.innerHTML = `<p>No matches in inventory for "${query}".</p>`;
        return;
      }

      resultsDiv.innerHTML = '';

      filtered.slice(0, 20).forEach(card => {
        const displayName = card.cardName + (card.foil ? " (Foil)" : "");
        const displaySet = (card.set || '').toUpperCase();
        const condition = card.condition || "Unknown";
        const cardImage = card.imageUrl || '';

        const cardDiv = document.createElement('div');
        cardDiv.className = 'delete-card-item';
        cardDiv.innerHTML = `
          <img src="${cardImage}" alt="${displayName}">
          <div class="delete-card-details">
            <strong>${displayName}</strong>
            <span>Set: ${displaySet}</span>
            <span>Condition: ${condition}</span>
            <button style="margin-top: 8px; background-color: crimson; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold;">Remove from Inventory</button>
          </div>
        `;

        cardDiv.querySelector('button').addEventListener('click', async () => {
          const confirmed = confirm(`Are you sure you want to delete 1x of "${displayName}" from ${displaySet}?`);
          if (!confirmed) return;

          document.getElementById('deleteCardName').value = card.cardName;
          document.getElementById('deleteSet').value = card.set;
          document.getElementById('deleteFoil').value = card.foil;
          document.getElementById('deleteVariantType').value = (card.variantType || '').toLowerCase().trim();

          document.getElementById('deleteColors').value = JSON.stringify(card.colors || []);
          document.getElementById('deleteCardType').value = card.cardType || '';
          document.getElementById('deleteCreatureTypes').value = JSON.stringify(card.creatureTypes || []);

          document.getElementById('delete-card-form').requestSubmit();
        });

        resultsDiv.appendChild(cardDiv);
      });

    } catch (err) {
      console.error('‚ùå Inventory search error:', err);
      resultsDiv.innerHTML = '<p>‚ùå Could not search inventory.</p>';
    }
  }

  document.getElementById('delete-card-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const cardName = document.getElementById('deleteCardName').value.trim();
    const cardSet = document.getElementById('deleteSet').value.trim();
    const isFoil = document.getElementById('deleteFoil').value === 'true';
    const variantType = document.getElementById('deleteVariantType')?.value || '';

    console.log('üõ†Ô∏è Deleting card with:', { cardName, set: cardSet, foil: isFoil, variantType });
    if (!cardName || !cardSet) return alert("Missing card name or set.");

    try {
      const res = await fetch("https://geega-games-website-production.up.railway.app/api/inventory/decrement", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cardName, set: cardSet, foil: isFoil, variantType })
      });

      if (!res.ok) throw new Error(`Decrement failed with status ${res.status}`);
      alert("‚úÖ Card quantity updated or removed.");
      document.getElementById('delete-card-form').reset();
    } catch (err) {
      console.error("‚ùå Delete Error:", err);
      alert("‚ùå Error updating inventory.");
    }
  });

  // ===== USERS =====
  async function loadUsers() {
    const userList = document.getElementById('user-list');
    try {
      const res = await fetch('https://geega-games-website-production.up.railway.app/api/users');
      if (!res.ok) throw new Error(`Server responded with ${res.status}`);
      const users = await res.json();

      if (!Array.isArray(users) || users.length === 0) {
        userList.innerHTML = "<p>No users found.</p>";
        return;
      }

      const table = document.createElement('table');
      table.style.width = '100%';
      table.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:left;">Name</th>
            <th style="text-align:left;">Email</th>
            <th style="text-align:left;">Phone</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(user => `
            <tr>
              <td>${capitalize(user.firstName)} ${capitalize(user.lastName)}</td>
              <td>${user.email || ''}</td>
              <td>${user.phone ? formatPhoneNumber(user.phone) : ''}</td>
            </tr>`).join('')}
        </tbody>
      `;
      userList.innerHTML = '';
      userList.appendChild(table);
    } catch (error) {
      userList.innerHTML = "<p>‚ùå Error loading users.</p>";
      console.error('‚ùå Fetch or render error:', error);
    }
  }

  loadUsers();

  // ===== ORDERS + SCRYFALL SEARCH =====
  let debounceTimeout;

  async function loadOrders() {
    const ordersList = document.getElementById('orders-list');
    const orderCountSpan = document.getElementById('order-count');
    ordersList.innerHTML = '<p>Loading orders...</p>';

    try {
      const res = await fetch('https://geega-games-website-production.up.railway.app/api/orders');
      const orders = await res.json();

      if (orderCountSpan) orderCountSpan.textContent = orders.length;

      if (!Array.isArray(orders) || orders.length === 0) {
        ordersList.innerHTML = "<p>No orders yet.</p>";
        return;
      }

      ordersList.innerHTML = orders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <h3>${order.firstName || '‚Äî'} ${order.lastName || ''}</h3>
            <div><strong>Total:</strong> $${(order.orderTotal || 0).toFixed(2)}</div>
          </div>

          <div class="order-details">
            <p><strong>Email:</strong> ${order.email || '‚Äî'}</p>
            <p><strong>Address:</strong> ${order.address || '‚Äî'}</p>
            <p><strong>Shipping:</strong> ${order.shippingMethod || '‚Äî'}</p>
            <p><strong>Payment:</strong> ${order.paymentMethod || '‚Äî'}</p>
            <p><strong>Date:</strong> ${order.submittedAt ? new Date(order.submittedAt).toLocaleString() : '‚Äî'}</p>
          </div>

          <h4 style="margin-top: 20px;">Cards:</h4>
          <ul class="card-list">
            ${(order.cards || []).map(card => `
              <li class="card-item-summary">
                <img src="${card.imageUrl || 'https://dummyimage.com/75x105/cccccc/000000&text=No+Image'}" alt="${card.cardName}" />
                <div class="card-info">
                  <div><strong>${card.cardName}</strong></div>
                  <div>${card.set || 'N/A'} ${card.foil ? '‚Ä¢ ‚ú® Foil' : ''}</div>
                  <div>Condition: ${card.condition || 'N/A'}</div>
                  <div>Qty: ${card.quantity || 1} | $${(card.priceUsd || 0).toFixed(2)} each</div>
                  <div><strong>Total:</strong> $${((card.priceUsd || 0) * (card.quantity || 1)).toFixed(2)}</div>
                  ${card.specialArt ? `<div><em>${card.specialArt}</em></div>` : ''}
                </div>
              </li>
            `).join('')}
          </ul>

          <div class="order-status" style="margin-top: 16px;">
            <strong>Status:</strong>
            <select onchange="updateOrderStatus('${order._id}', this.value)">
              ${['Pending', 'Packing', 'Dropped Off', 'Shipped'].map(status => `
                <option value="${status}" ${order.status === status || (!order.status && status === 'Pending') ? 'selected' : ''}>${status}</option>
              `).join('')}
            </select>
          </div>

          <div class="order-tracking" style="margin-top: 10px;">
            <strong>Tracking #:</strong>
            <input type="text" id="tracking-${order._id}" value="${order.trackingNumber || ''}" placeholder="Optional..." />
            <button onclick="saveTracking('${order._id}')">Save</button>
            <button onclick="printLabel('${order._id}')" style="background: seagreen; margin-left: 6px;">Print Label</button>
          </div>
        </div>
      `).join('');
    } catch (err) {
      console.error('‚ùå Error loading orders:', err);
      ordersList.innerHTML = '<p>‚ùå Failed to load orders.</p>';
    }
  }

  const ordersTab = document.querySelector('a[href="#"][onclick*="orders-section"]');
  if (ordersTab) ordersTab.addEventListener('click', loadOrders);

  document.getElementById('search-input').addEventListener('input', function () {
    clearTimeout(debounceTimeout);
    const query = this.value.trim();
    const resultsDiv = document.getElementById('search-results');
    if (!query) {
      resultsDiv.innerHTML = '';
      return;
    }
    debounceTimeout = setTimeout(() => searchScryfall(query), 300);
  });

  function getVariantTypes(card) {
    const variants = [];
    const frame = card.frame_effects || [];
    const promo = card.promo_types || [];
    const finishes = card.finishes || [];
    const finish = card.finish || '';

    if (frame.includes('showcase')) variants.push('Showcase');
    if (frame.includes('extendedart')) variants.push('Extended Art');
    if (frame.includes('borderless')) variants.push('Borderless');

    if (promo.includes('fullart')) variants.push('Full-Art');
    if (promo.includes('retro')) variants.push('Retro Frame');
    if (promo.includes('textless')) variants.push('Textless');
    if (promo.includes('phyrexian')) variants.push('Phyrexian');
    if (promo.includes('serialized')) variants.push('Serialized');

    if (finish === 'etched' || finishes.includes('etched')) variants.push('Etched Foil');
    if (finish === 'gilded' || finishes.includes('gilded')) variants.push('Gilded Foil');
    if (finish === 'rainbow_foil' || finishes.includes('rainbow_foil')) variants.push('Rainbow Foil');

    return [...new Set(variants)];
  }

  async function fetchAllPrints(printsSearchUri, maxCards = 500) {
    let url = printsSearchUri;
    let all = [];

    while (url && all.length < maxCards) {
      const res = await fetch(url);
      if (!res.ok) break;

      const json = await res.json();
      if (Array.isArray(json.data)) all.push(...json.data);

      url = json.has_more ? json.next_page : null;
    }

    return all;
  }

  // ‚úÖ Helpers: better color + type extraction (DFCs + commander color identity)
  function pickTypeLine(c) {
    return c.type_line || c.card_faces?.[0]?.type_line || '';
  }

  function pickColors(c) {
    return Array.isArray(c.color_identity) ? c.color_identity : (c.colors || []);
  }

  // ‚úÖ NEW: single "bucket" field so multi-color becomes "Multicolor"
  function computeColorCategory(colors) {
    const arr = Array.isArray(colors) ? colors.filter(Boolean) : [];
    if (arr.length === 0) return "Colorless";
    if (arr.length === 1) return arr[0]; // W/U/B/R/G
    return "Multicolor";
  }

  function matchesColorFilter(card, selectedColor) {
  // selectedColor should be: "", "Colorless", "W", "U", "B", "R", "G", "Multicolor"
  if (!selectedColor) return true;

  // Backward compatible: if old items don't have colorCategory yet
  const cat = (card.colorCategory || computeColorCategory(card.colors || [])).trim();

  // Multicolor cards only match Multicolor ‚Äî never W/U/B/R/G
  if (selectedColor === "Multicolor") return cat === "Multicolor";

  // Single color and colorless must match exactly
  return cat === selectedColor;
}

  // ‚úÖ FIXED: handle em dash OR hyphen in type line
  function extractCreatureTypesFromTypeLine(typeLine) {
    if (!/Creature/i.test(typeLine)) return [];
    const parts = typeLine.split(/‚Äî|-/); // supports both
    if (!parts[1]) return [];
    return parts[1].trim().split(/\s+/).filter(Boolean);
  }

  async function searchScryfall(query) {
    const resultsDiv = document.getElementById('search-results');
    query = query.trim();

    if (query.length < 2) {
      resultsDiv.innerHTML = `<p>‚ùó Please type at least 2 characters.</p>`;
      return;
    }

    resultsDiv.innerHTML = `<p>Searching for "<strong>${query}</strong>"...</p>`;

    try {
      const searchRes = await fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(query)}`);
      if (!searchRes.ok) throw new Error('Card not found');

      const baseCard = await searchRes.json();
      const prints = await fetchAllPrints(baseCard.prints_search_uri, 600);

      const byId = new Map();
      [baseCard, ...prints].forEach(c => byId.set(c.id, c));
      let cards = Array.from(byId.values());

      cards.sort((a, b) => {
        const da = a.released_at || "";
        const db = b.released_at || "";
        return db.localeCompare(da);
      });

      resultsDiv.innerHTML = '';

      cards.slice(0, 80).forEach(card => {
        const imageUrl =
          card.image_uris?.normal ||
          card.card_faces?.[0]?.image_uris?.normal ||
          'https://dummyimage.com/223x310/eeeeee/000000&text=No+Image';

        const set = card.set_name || 'Unknown Set';
        const usd = parseFloat(card.prices?.usd || 0);
        const usdFoil = parseFloat(card.prices?.usd_foil || card.prices?.usd || 0);

        const treatments = getVariantTypes(card);
        const displayName = `${card.name}${treatments.length ? ` (${treatments.join(', ')})` : ''}`;

        const cardType = pickTypeLine(card);
        const colors = pickColors(card);
        const colorCategory = computeColorCategory(colors);

        const rarity = (card.rarity || '').toLowerCase();
        const isRare = rarity === 'rare'; // rare only
        // const isRare = (rarity === 'rare' || rarity === 'mythic'); // rare + mythic

        const creatureTypes = extractCreatureTypesFromTypeLine(cardType);

        const foilId = `foil-${Math.random().toString(36).slice(2)}`;
        const conditionId = `cond-${Math.random().toString(36).slice(2)}`;

        const foilOptions = card.finishes?.includes('foil') && card.finishes?.includes('nonfoil')
          ? `<label><input type="checkbox" id="${foilId}" class="foil-checkbox"> Foil</label>`
          : card.finishes?.length === 1 && card.finishes[0] === 'foil'
            ? `<span style="font-size: 0.9em; color: #6a2f9c;">‚ú® Foil Only</span>`
            : '';

        const cardDiv = document.createElement('div');
        cardDiv.className = 'card-item';
        cardDiv.innerHTML = `
          <img src="${imageUrl}" alt="${displayName}">
          <div class="card-details">
            <strong>${displayName}</strong>
            <span>Set: ${set}</span>
            ${foilOptions}
            <label for="${conditionId}">Condition:</label>
            <select id="${conditionId}" class="condition-select">
              <option value="NM">Near Mint</option>
              <option value="LP">Lightly Played</option>
              <option value="MP">Moderately Played</option>
              <option value="HP">Heavily Played</option>
              <option value="DMG">Damaged</option>
            </select>
            <button class="add-button">Add / Update</button>
          </div>
        `;

        const foilCheckbox = cardDiv.querySelector('.foil-checkbox');

        function clampRareMin(v) {
          const num = parseFloat(v) || 0;
          if (isRare && num < 0.75) return 0.75;
          return num;
        }

        if (foilCheckbox) {
          foilCheckbox.addEventListener('change', () => {
            const next = foilCheckbox.checked ? usdFoil : usd;
            const clamped = clampRareMin(next);
            document.getElementById('price').value = clamped.toFixed(2);
          });
        }

        cardDiv.querySelector('.add-button').addEventListener('click', () => {
          const isFoilSelected =
            (card.finishes?.length === 1 && card.finishes[0] === 'foil')
              ? true
              : (foilCheckbox?.checked || false);

          const condition = cardDiv.querySelector('.condition-select')?.value || 'NM';

          document.getElementById('cardName').value = card.name;
          document.getElementById('set').value = set;
          document.getElementById('foil').checked = isFoilSelected;
          document.getElementById('condition').value = condition;
          document.getElementById('imageUrl').value = imageUrl;
          document.getElementById('quantity').value = 1;
          document.getElementById('rarity').value = rarity;

          const base = isFoilSelected ? usdFoil : usd;
          const clamped = clampRareMin(base);
          const priceInput = document.getElementById('price');
          priceInput.value = clamped.toFixed(2);
          priceInput.min = isRare ? "0.75" : "0";

          document.getElementById('variantType').value = treatments.join(', ');

          const variantInput = document.getElementById('variantType');
          variantInput.classList.add('highlighted');
          setTimeout(() => variantInput.classList.remove('highlighted'), 1500);

          const form = document.getElementById('update-card-form');

          // ‚úÖ Store metadata for submit:
          form.dataset.colors = JSON.stringify(colors);
          form.dataset.colorCategory = colorCategory;     // ‚úÖ NEW
          form.dataset.cardType = cardType;
          form.dataset.creatureTypes = JSON.stringify(creatureTypes);

          // Helpful debug:
          // console.log("üß¨ TypeLine:", cardType);
          // console.log("üß¨ CreatureTypes:", creatureTypes);
          // console.log("üé® Colors:", colors, "‚Üí", colorCategory);

          resultsDiv.innerHTML = '';
          document.getElementById('cardName').scrollIntoView({ behavior: 'smooth' });
        });

        resultsDiv.appendChild(cardDiv);
      });

    } catch (err) {
      console.error('‚ùå Scryfall error:', err);
      resultsDiv.innerHTML = `<p>‚ùå Could not find a card for "<strong>${query}</strong>".</p>`;
    }
  }

  async function updateOrderCount() {
    try {
      const res = await fetch('https://geega-games-website-production.up.railway.app/api/orders');
      const orders = await res.json();
      document.getElementById('order-count').textContent = orders.length;
    } catch (err) {
      console.error("‚ùå Failed to update order count", err);
    }
  }

  // ===== INVENTORY SUBMIT =====
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("update-card-form");
    if (!form) {
      console.warn("Form not found");
      return;
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // ‚úÖ Guard: ensure user clicked a Scryfall result so metadata exists
      if (!form.dataset.cardType) {
        alert("‚ö†Ô∏è Please click a Scryfall search result first so card metadata (type/colors/creature types) is captured.");
        return;
      }

      const rarity = (document.getElementById("rarity")?.value || "").toLowerCase().trim();

      let price = parseFloat(document.getElementById("price").value);
      if (isNaN(price)) price = 0;

      const isRareOrMythic = (rarity === "rare" || rarity === "mythic");
      if (isRareOrMythic && price < 0.75) price = 0.75;

      document.getElementById("price").value = price.toFixed(2);

      const isFoil = document.getElementById("foil").checked;

      const cardData = {
        cardName: document.getElementById("cardName").value.trim(),
        quantity: parseInt(document.getElementById("quantity").value, 10) || 0,
        set: document.getElementById("set").value.trim(),
        condition: document.getElementById("condition").value,
        foil: isFoil,
        imageUrl: document.getElementById("imageUrl").value,
        variantType: document.getElementById("variantType").value.trim(),

        price: price,
        priceUsd: price,
        priceUsdFoil: isFoil ? price : undefined,

        rarity: rarity,

        colors: JSON.parse(form.dataset.colors || "[]"),
        colorCategory: form.dataset.colorCategory || "Colorless",   // ‚úÖ NEW
        cardType: form.dataset.cardType || "",
        creatureTypes: JSON.parse(form.dataset.creatureTypes || "[]")
      };

      Object.keys(cardData).forEach(k => cardData[k] === undefined && delete cardData[k]);

      console.log("üì¶ Submitting cardData:", cardData);

      try {
        const response = await fetch("https://geega-games-website-production.up.railway.app/api/inventory", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(cardData)
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(result.message || `Failed: ${response.status}`);

        alert("‚úÖ Card added / updated successfully!");
        form.reset();
        form.dataset.colors = "[]";
        form.dataset.colorCategory = "Colorless"; // ‚úÖ NEW
        form.dataset.cardType = "";
        form.dataset.creatureTypes = "[]";
      } catch (error) {
        console.error("‚ùå Add Card Error:", error);
        alert(`‚ùå Error adding card: ${error.message}`);
      }
    });
  });

  // ===== INITIAL LOAD =====
  document.addEventListener('DOMContentLoaded', () => {
    showSection('inventory-section');
    initMtgTrends();
    updateOrderCount();
    loadInventorySummary();
  });

  // ===== UTILITIES =====
  function formatPhoneNumber(phone) {
    const digits = phone.replace(/\D/g, '');
    const clean = digits.startsWith('1') && digits.length === 11 ? digits.slice(1) : digits;
    if (clean.length !== 10) return phone;
    return `(${clean.slice(0, 3)}) ${clean.slice(3, 6)}-${clean.slice(6)}`;
  }

  function capitalize(word) {
    return word ? word.charAt(0).toUpperCase() + word.slice(1).toLowerCase() : '';
  }
</script>
  
</body>
</html>
